-- Stored procedure for booking seats with concurrency control
DELIMITER //

CREATE PROCEDURE book_seats(
    IN p_show_id INT,
    IN p_customer_name VARCHAR(255),
    IN p_customer_email VARCHAR(255),
    IN p_seat_ids TEXT  -- comma-separated seat IDs
)
BEGIN
    DECLARE v_booking_id INT;
    DECLARE v_total_amount DECIMAL(10,2);
    DECLARE v_seat_count INT;
    DECLARE v_base_price DECIMAL(10,2);
    DECLARE exit handler for sqlexception
    BEGIN
        ROLLBACK;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Booking failed due to concurrent access or invalid data';
    END;

    -- Start transaction
    START TRANSACTION;

    -- Get base price for the show
    SELECT base_price INTO v_base_price 
    FROM shows 
    WHERE show_id = p_show_id;

    -- Create booking record
    INSERT INTO bookings (show_id, customer_name, customer_email, total_amount, payment_status)
    VALUES (p_show_id, p_customer_name, p_customer_email, 0, 'Pending');
    
    SET v_booking_id = LAST_INSERT_ID();

    -- Process each seat
    -- Convert comma-separated string to rows and process
    -- For simplicity, assuming seats are passed as individual parameters
    
    -- For each seat, check availability and book
    -- This is a simplified version - in real implementation, 
    -- you'd parse the comma-separated string
    
    -- Update total amount
    UPDATE bookings 
    SET total_amount = v_base_price * v_seat_count
    WHERE booking_id = v_booking_id;

    COMMIT;
END//

DELIMITER ;

-- Function to check and book specific seats
DELIMITER //

CREATE FUNCTION book_specific_seat(
    p_booking_id INT,
    p_seat_id INT,
    p_price DECIMAL(10,2)
) RETURNS BOOLEAN
DETERMINISTIC
BEGIN
    DECLARE v_available BOOLEAN DEFAULT FALSE;
    
    -- Check if seat is available using row-level locking
    SELECT NOT EXISTS (
        SELECT 1 
        FROM booking_seats bs
        JOIN bookings b ON bs.booking_id = b.booking_id
        JOIN shows s ON b.show_id = s.show_id
        JOIN seats seat ON bs.seat_id = seat.seat_id
        WHERE bs.seat_id = p_seat_id
        AND s.show_id = (SELECT show_id FROM bookings WHERE booking_id = p_booking_id)
        AND b.payment_status = 'Completed'
        FOR UPDATE
    ) INTO v_available;

    IF v_available THEN
        INSERT INTO booking_seats (booking_id, seat_id, price)
        VALUES (p_booking_id, p_seat_id, p_price);
        RETURN TRUE;
    ELSE
        RETURN FALSE;
    END IF;
END//

DELIMITER ;
